---
import GitHub from "./icons/GitHub.astro"
import NextJS from "./icons/NextJS.astro"
import Tailwind from "./icons/Tailwind.astro"
import Python from "./icons/Python.astro"
import CLI from "./icons/CLI.astro"
import Automation from "./icons/Automation.astro"
import IA from "./icons/IA.astro"
import Script from "./icons/Script.astro"
import CSharp from "./icons/CSharp.astro"
import DotNet from "./icons/DotNet.astro"
import Playwright from "./icons/Playwright.astro"
import AFIP from "./icons/AFIP.astro"
import Consola from "./icons/Consola.astro"
import OpenSource from "./icons/OpenSource.astro"
import OCR from "./icons/OCR.astro"
import Tesseract from "./icons/Tesseract.astro"
import Telegram from "./icons/Telegram.astro"
import Azure from "./icons/Azure.astro"
import OpenAI from "./icons/OpenAI.astro"
import Streamlit from "./icons/Streamlit.astro"
import WebApp from "./icons/WebApp.astro"
import Scraping from "./icons/Scraping.astro"
import Link from "./icons/Link.astro"
import LinkButton from "./LinkButton.astro"
import { getI18n } from "@/i18n"
import type { Lang, ProjectId, TagKey } from "@/i18n"

interface Props {
  lang?: Lang
}

const { lang = "es" } = Astro.props
const text = getI18n(lang)
const projectItems = text.projects.items as Record<
  ProjectId,
  { title: string; description: string }
>
const projectTags = text.projects.tags as Record<TagKey, string>

type ProjectMeta = {
  id: ProjectId
  link: string
  github: string
  image: string
  tags: TagKey[]
  imageClass?: string
}

const TAGS = {
  NEXT: { class: "bg-black text-white", icon: NextJS },
  TAILWIND: { class: "bg-[#003159] text-white", icon: Tailwind },
  PYTHON: { class: "bg-[#306998] text-white", icon: Python },
  CLI: { class: "bg-zinc-900 text-white", icon: CLI },
  AUTOMATION: { class: "bg-emerald-700 text-white", icon: Automation },
  IA: { class: "bg-violet-700 text-white", icon: IA },
  SCRIPT: { class: "bg-amber-600 text-white", icon: Script },
  CSHARP: { class: "bg-[#512BD4] text-white", icon: CSharp },
  DOTNET9: { class: "bg-[#512BD4] text-white", icon: DotNet },
  PLAYWRIGHT: { class: "bg-lime-700 text-white", icon: Playwright },
  AFIP: { class: "bg-sky-700 text-white", icon: AFIP },
  CONSOLA: { class: "bg-zinc-800 text-white", icon: Consola },
  OPEN_SOURCE: { class: "bg-indigo-700 text-white", icon: OpenSource },
  OCR: { class: "bg-fuchsia-700 text-white", icon: OCR },
  TESSERACT: { class: "bg-slate-700 text-white", icon: Tesseract },
  TELEGRAM: { class: "bg-sky-600 text-white", icon: Telegram },
  AZURE: { class: "bg-blue-700 text-white", icon: Azure },
  OPENAI: { class: "bg-neutral-900 text-white", icon: OpenAI },
  STREAMLIT: { class: "bg-rose-600 text-white", icon: Streamlit },
  WEB_APP: { class: "bg-teal-700 text-white", icon: WebApp },
  SCRAPING: { class: "bg-cyan-700 text-white", icon: Scraping },
}

const PROJECTS_OWN: ProjectMeta[] = [
  {
    id: "filesTools",
    link: "",
    github: "https://github.com/gteijeiro/files-tools",
    image: "/projects/consola.png",
    tags: ["PYTHON", "CLI", "IA", "SCRIPT", "CONSOLA", "OPEN_SOURCE"] as TagKey[],
  },
  {
    id: "arcaLpgScraper",
    link: "",
    github: "https://github.com/gteijeiro/arca-lpgscraper",
    image: "/projects/consola.png",
    tags: [
      "CSHARP",
      "DOTNET9",
      "PLAYWRIGHT",
      "AFIP",
      "CLI",
      "CONSOLA",
      "OPEN_SOURCE",
    ] as TagKey[],
  },
  {
    id: "arcaLpgOcr",
    link: "",
    github: "https://github.com/gteijeiro/arca-lpg-ocr",
    image: "/projects/consola.png",
    tags: ["PYTHON", "CLI", "CONSOLA", "OCR", "TESSERACT", "OPEN_SOURCE"] as TagKey[],
  },
  {
    id: "telegramBot",
    link: "",
    github: "https://github.com/gteijeiro/telegramBot",
    image: "/projects/bottelegram.png",
    imageClass: "object-top",
    tags: ["PYTHON", "TELEGRAM", "AZURE", "OPENAI", "OCR", "OPEN_SOURCE"] as TagKey[],
  },
  {
    id: "aiCodegen",
    link: "",
    github: "https://github.com/gteijeiro/codegen",
    image: "/projects/codegenia.png",
    tags: ["PYTHON", "STREAMLIT", "WEB_APP", "IA", "AZURE", "OPENAI", "OPEN_SOURCE"] as TagKey[],
  },
  {
    id: "quini6Bot",
    link: "",
    github: "https://github.com/gteijeiro/quini6-bot",
    image: "/projects/consola.png",
    tags: ["PYTHON", "TELEGRAM", "AZURE", "SCRAPING", "OPEN_SOURCE"] as TagKey[],
  },
]

const PROJECTS_WORK: ProjectMeta[] = [
  {
    id: "workDummy",
    link: "",
    github: "",
    image: "/projects/consola.png",
    tags: ["AZURE"] as TagKey[],
  },
]

const createId = (title: string) =>
  title
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, "-")
    .replace(/(^-|-$)/g, "")

const getExcerpt = (text: string, limit = 180) => {
  if (text.length <= limit) return text
  return `${text.slice(0, limit).trimEnd()}...`
}

const groups = [
  {
    title: text.projects.groups.own.title,
    description: text.projects.groups.own.description,
    items: PROJECTS_OWN,
  },
  {
    title: text.projects.groups.work.title,
    description: text.projects.groups.work.description,
    items: PROJECTS_WORK,
  },
]
---

<div class="flex flex-col gap-y-16">
  {groups.map((group) => (
    <section class="flex flex-col gap-y-6">
      <header class="space-y-2">
        <h3 class="text-2xl md:text-3xl font-semibold text-gray-900 dark:text-gray-100">
          {group.title}
        </h3>
        <p class="text-gray-600 dark:text-gray-400">{group.description}</p>
      </header>

      {group.items.length === 0 ? (
        <div class="rounded-2xl border border-dashed border-gray-300 dark:border-gray-700 p-8 text-gray-600 dark:text-gray-400">
          {text.projects.empty}
        </div>
      ) : (
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-fr">
          {group.items.map((item: ProjectMeta) => {
            const { id, image, tags, link, github, imageClass } = item
            const projectId = createId(id)
            const projectTitle = projectItems[id].title
            const projectDescription = projectItems[id].description
            const imageStyle = imageClass ?? "object-center"

            return (
              <article class="group h-full reveal reveal-children">
                <button
                  type="button"
                  data-modal-target={`project-${projectId}`}
                  class="h-full w-full text-left rounded-2xl border border-gray-200 dark:border-gray-800 bg-white/70 dark:bg-gray-900/50 backdrop-blur transition duration-300 hover:-translate-y-1 hover:shadow-xl"
                >
                  <div class="overflow-hidden rounded-t-2xl reveal-child" style="--reveal-delay: 0ms;">
                    <div class="aspect-video w-full bg-white/40 dark:bg-gray-900/40">
                      <img
                        alt={projectTitle}
                        class={`w-full h-full object-cover ${imageStyle}`}
                        loading="lazy"
                        decoding="async"
                        src={image}
                      />
                    </div>
                  </div>
                  <div class="p-4 flex flex-col gap-3">
                    <div class="reveal-child" style="--reveal-delay: 80ms;">
                      <h4 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
                        {projectTitle}
                      </h4>
                      <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                        {getExcerpt(projectDescription)}
                      </p>
                    </div>
                    <ul class="flex flex-wrap gap-2 reveal-child" style="--reveal-delay: 160ms;">
                      {tags.map((tagKey: TagKey) => {
                        const tag = TAGS[tagKey]
                        const TagIcon = tag.icon

                        return (
                        <li>
                          <span
                            class={`inline-flex items-center gap-x-2 rounded-full text-xs ${tag.class} py-1 px-2`}
                          >
                            <TagIcon class="size-4" />
                              <span class="whitespace-nowrap">{projectTags[tagKey]}</span>
                          </span>
                        </li>
                        )
                      })}
                    </ul>
                    <span
                      class="text-xs font-medium text-gray-700 dark:text-gray-300 reveal-child"
                      style="--reveal-delay: 220ms;"
                    >
                      {text.projects.details}
                    </span>
                  </div>
                </button>

                <dialog
                  id={`project-${projectId}`}
                  class="rounded-2xl w-full max-w-2xl bg-white text-gray-900 shadow-2xl backdrop:bg-black/50 dark:bg-gray-950 dark:text-gray-100"
                >
                  <div class="p-6 sm:p-8 space-y-5">
                    <div class="flex flex-col gap-4">
                      <div class="overflow-hidden rounded-xl">
                        <div class="aspect-video w-full bg-white/40 dark:bg-gray-900/40">
                          <img
                            alt={projectTitle}
                            class={`w-full h-full object-cover ${imageStyle}`}
                            loading="lazy"
                            decoding="async"
                            src={image}
                          />
                        </div>
                      </div>
                      <div>
                        <h4 class="text-2xl font-semibold">{projectTitle}</h4>
                        <p class="mt-3 text-gray-700 dark:text-gray-300">{projectDescription}</p>
                      </div>
                    </div>

                    <ul class="flex flex-wrap gap-2">
                      {tags.map((tagKey: TagKey) => {
                        const tag = TAGS[tagKey]
                        const TagIcon = tag.icon

                        return (
                        <li>
                          <span
                            class={`inline-flex items-center gap-x-2 rounded-full text-xs ${tag.class} py-1 px-2`}
                          >
                            <TagIcon class="size-4" />
                              <span class="whitespace-nowrap">{projectTags[tagKey]}</span>
                          </span>
                        </li>
                        )
                      })}
                    </ul>

                    <footer class="flex flex-wrap items-center justify-between gap-3">
                      <div class="flex flex-wrap items-center gap-3">
                        {github && (
                          <LinkButton href={github}>
                            <GitHub class="size-6" />
                            Code
                          </LinkButton>
                        )}
                        {link && (
                          <LinkButton href={link}>
                            <Link class="size-4" />
                            Preview
                          </LinkButton>
                        )}
                      </div>
                      <button
                        type="button"
                        data-modal-close
                        class="text-sm font-medium text-gray-700 dark:text-gray-300"
                      >
                        {text.projects.close}
                      </button>
                    </footer>
                  </div>
                </dialog>
              </article>
            )
          })}
        </div>
      )}
    </section>
  ))}
</div>

<script>
  const attachProjectModals = () => {
    const openButtons = document.querySelectorAll("[data-modal-target]")
    const closeButtons = document.querySelectorAll("[data-modal-close]")

    openButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const targetId = button.getAttribute("data-modal-target")
        const dialog = targetId ? document.getElementById(targetId) : null

        if (dialog instanceof HTMLDialogElement) {
          dialog.showModal()
        }
      })
    })

    closeButtons.forEach((button) => {
      button.addEventListener("click", (event) => {
        const target = event.currentTarget
        const dialog =
          target instanceof HTMLElement ? target.closest("dialog") : null

        if (dialog instanceof HTMLDialogElement) {
          dialog.close()
        }
      })
    })

    document.querySelectorAll("dialog").forEach((dialog) => {
      dialog.addEventListener("click", (event) => {
        if (event.target === dialog) {
          dialog.close()
        }
      })
    })
  }

  document.addEventListener("astro:page-load", attachProjectModals)
  attachProjectModals()
</script>
